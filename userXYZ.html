
<!-- <!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8" />
    <title>Socket.IO Room Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .room-section {
        border: 1px solid #ccc;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
      }
      .chat-section {
        border: 1px solid #007bff;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
      }
      .message-input {
        width: 70%;
        padding: 8px;
        margin-right: 10px;
      }
      .send-button {
        padding: 8px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      .send-button:hover {
        background-color: #0056b3;
      }
      .send-button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      #log {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        height: 300px;
        overflow-y: auto;
        font-family: monospace;
      }
      .message {
        margin: 5px 0;
        padding: 8px;
        border-radius: 5px;
      }
      .message.sent {
        background-color: #d4edda;
        text-align: right;
      }
      .message.received {
        background-color: #f8d7da;
      }
      .status {
        color: #666;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <h1>Socket.IO Chat Application</h1>

    <div class="room-section">
      <h2>
        XYZ USER :<br />
        6cb0985e-b1a7-4845-97a3-7c295ab04cef
      </h2>
      <h2>Room Management</h2>
      <label>Chat Type:</label>
      <input
        type="text"
        id="chatType"
        placeholder="DIRECT or LISTING"
      /><br /><br />

      <label>Participant IDs (comma separated):</label>
      <input
        type="text"
        id="participantIds"
        placeholder="user1,user2"
      /><br /><br />

      <label>Listing ID :</label>
      <input
        type="text"
        id="listingId"
        placeholder="Listing ID here if chat type is LISTING"
      /><br /><br />

      <button onclick="joinOrCreateRoom()">Join or Create Room</button>
      <div class="status" id="roomStatus">Not connected to any room</div>
    </div>

    <div class="chat-section">
      <h2>Chat Messages</h2>
      <div>
        <input
          type="text"
          id="messageInput"
          class="message-input"
          placeholder="Type your message..."
          disabled
        />
        <button
          id="sendButton"
          class="send-button"
          onclick="sendMessage()"
          disabled
        >
          Send
        </button>
      </div>
      <div
        id="messages"
        style="
          margin-top: 15px;
          height: 200px;
          overflow-y: auto;
          border: 1px solid #ddd;
          padding: 10px;
        "
      ></div>
    </div>

    <h2>System Log</h2>
    <pre id="log"></pre>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      const socket = io("http://localhost:8000", {
        auth: {
          token:
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjp7ImlkIjoiNmNiMDk4NWUtYjFhNy00ODQ1LTk3YTMtN2MyOTVhYjA0Y2VmIn0sImlhdCI6MTc1MDQ4NzQyMiwiZXhwIjoxNzUzMDc5NDIyfQ.P3f_sKwS0bYgayNxZT6818CnsAEiKHLa48lO0Fqsv7E",
        },
      });

      let currentRoomId = null;

      // Connection events
      socket.on("connect", () => {
        log("‚úÖ Connected to server");
      });

      socket.on("disconnect", () => {
        log("‚ùå Disconnected from server");
        updateRoomStatus("Disconnected from server");
        disableChat();
      });

      // Room events
      socket.on("room_created", (data) => {
        log("üéâ Room Created:");
        log(JSON.stringify(data, null, 2));
        currentRoomId = data.roomId || data.id;
        updateRoomStatus(`Connected to room: ${currentRoomId}`);
        enableChat();
      });

      socket.on("room_joined", (data) => {
        log("üëã Joined Existing Room:");
        log(JSON.stringify(data, null, 2));
        currentRoomId = data.roomId || data.id;
        updateRoomStatus(`Joined room: ${currentRoomId}`);
        enableChat();
      });

      socket.on("new_room", (data) => {
        log("üîî New Room Notification:");
        log(JSON.stringify(data, null, 2));
      });

      // Message events
      socket.on("receive_message", (data) => {
        log("üì® Message Received:");
        log(JSON.stringify(data, null, 2));
        displayMessage(data, "received");
      });

      socket.on("notify", (data) => {
        log("üì® New Message Received :");
        log(JSON.stringify(data, null, 2));
        displayMessage(data, "received");
      });

      socket.on("message_sent", (data) => {
        log("üì§ Message Sent Confirmation:");
        log(JSON.stringify(data, null, 2));
      });

      // Error events
      socket.on("error", (err) => {
        log("‚ùó Error: " + err.message);
        updateRoomStatus("Error: " + err.message);
      });
      function joinOrCreateRoom() {
        const type = document
          .getElementById("chatType")
          .value.trim()
          .toUpperCase();

        const listingId = document.getElementById("listingId").value.trim();

        const participantIds = document
          .getElementById("participantIds")
          .value.split(",")
          .map((s) => s.trim());

        if (!type || participantIds.length === 0) {
          log("‚ùó Please provide both chat type and participant IDs.");
          return;
        }

        socket.emit("joinOrCreateRoom", {
          type,
          participantIds,
          listingId,
        });
      }

      function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const message = messageInput.value.trim();

        if (!message) {
          log("‚ùó Please enter a message.");
          return;
        }

        if (!currentRoomId) {
          log("‚ùó Please join a room first.");
          return;
        }

        const messageData = {
          roomId: currentRoomId,
          content: message,
          timestamp: new Date().toISOString(),
        };

        socket.emit("send_message", messageData);

        // Display the sent message immediately
        // displayMessage(
        //   {
        //     content: message,
        //     sender: "You",
        //     timestamp: messageData.timestamp,
        //   },
        //   "sent"
        // );

        // Clear the input
        messageInput.value = "";
      }

      function displayMessage(data, type) {
        const messagesDiv = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;

        const sender =
          type === "sent" ? "You" : data.sender.fullName || "Unknown";
        const timestamp = data.timestamp
          ? new Date(data.timestamp).toLocaleTimeString()
          : new Date().toLocaleTimeString();

        messageDiv.innerHTML = `
                <strong>${sender}</strong> <small>(${timestamp})</small><br>
                ${data.content}
            `;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function updateRoomStatus(status) {
        document.getElementById("roomStatus").textContent = status;
      }

      function enableChat() {
        document.getElementById("messageInput").disabled = false;
        document.getElementById("sendButton").disabled = false;
      }

      function disableChat() {
        document.getElementById("messageInput").disabled = true;
        document.getElementById("sendButton").disabled = true;
      }

      function log(msg) {
        const logElement = document.getElementById("log");
        logElement.textContent += msg + "\n";
        logElement.scrollTop = logElement.scrollHeight;
      }

      // Enable sending message with Enter key
      document
        .getElementById("messageInput")
        .addEventListener("keypress", function (event) {
          if (event.key === "Enter") {
            sendMessage();
          }
        });
    </script>
  </body>
</html> -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Modern Chat Application</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        display: flex;
        height: 100vh;
        max-width: 1400px;
        margin: 0 auto;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      /* Sidebar */
      .sidebar {
        width: 350px;
        background: #f8f9fa;
        border-right: 1px solid #e9ecef;
        display: flex;
        flex-direction: column;
      }

      .sidebar-header {
        padding: 20px;
        background: #fff;
        border-bottom: 1px solid #e9ecef;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }

      .connection-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #666;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #dc3545;
        animation: pulse 2s infinite;
      }

      .status-dot.connected {
        background: #28a745;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      /* Room Creation */
      .room-creation {
        padding: 15px 20px;
        background: #fff;
        border-bottom: 1px solid #e9ecef;
      }

      .form-group {
        margin-bottom: 12px;
      }

      .form-group label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: #666;
        margin-bottom: 4px;
        text-transform: uppercase;
      }

      .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd; /* Fixed CSS typo */
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s;
      }

      .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .btn-primary {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
        font-size: 12px;
        padding: 6px 12px;
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      /* Room List */
      .rooms-section {
        flex: 1;
        overflow-y: auto;
      }

      .section-header {
        padding: 15px 20px 10px;
        font-size: 12px;
        font-weight: 600;
        color: #666;
        text-transform: uppercase;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .room-item {
        padding: 12px 16px;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 3px solid transparent;
        position: relative;
        border-bottom: 1px solid #f0f0f0;
      }

      .room-item:hover {
        background: #f8f9fa;
        transform: translateX(2px);
      }

      .room-item.active {
        background: linear-gradient(90deg, #e3f2fd 0%, #f8f9fa 100%);
        border-left-color: #667eea;
      }

      .room-info {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }

      .room-avatar {
        position: relative;
        flex-shrink: 0;
      }

      .room-avatar img {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
      }

      .avatar-placeholder {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(45deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 18px;
      }

      .online-indicator {
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 12px;
        height: 12px;
        background: #28a745;
        border: 2px solid white;
        border-radius: 50%;
      }

      .room-details {
        flex: 1;
        min-width: 0;
      }

      .room-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 4px;
      }

      .room-header h4 {
        font-size: 15px;
        font-weight: 600;
        margin: 0;
        color: #1a1a1a;
      }

      .room-meta {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .timestamp {
        font-size: 11px;
        color: #666;
        white-space: nowrap;
      }

      .unread-badge {
        background: #667eea;
        color: white;
        border-radius: 10px;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: 600;
        min-width: 18px;
        text-align: center;
      }

      .room-subtitle {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: #666;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .own-message {
        color: #667eea;
        font-weight: 500;
      }

      .unread-dot {
        color: #667eea;
        font-size: 8px;
      }

      .room-type {
        font-size: 11px;
        color: #999;
        text-transform: capitalize;
      }

      /* Chat Area */
      .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
      }

      .chat-header {
        padding: 20px;
        background: #fff;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .chat-title {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .chat-title h3 {
        margin: 0;
        font-size: 16px;
      }

      .chat-subtitle {
        font-size: 12px;
        color: #666;
      }

      .chat-actions {
        display: flex;
        gap: 8px;
      }

      /* Messages */
      .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
      }

      .message {
        margin-bottom: 16px;
        display: flex;
        gap: 12px;
        animation: fadeIn 0.3s ease;
        max-width: 100%;
      }

      .message.own {
        flex-direction: row-reverse;
        justify-content: flex-start;
        margin-left: auto;
        margin-right: 0;
      }

      .message:not(.own) {
        justify-content: flex-start;
        margin-left: 0;
        margin-right: auto;
      }

      .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(45deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
        flex-shrink: 0;
      }

      .message.own .message-avatar {
        background: linear-gradient(45deg, #28a745, #20c997);
      }

      .message-content {
        max-width: 70%;
        display: flex;
        flex-direction: column;
      }

      .message.own .message-content {
        align-items: flex-end;
      }

      .message:not(.own) .message-content {
        align-items: flex-start;
      }

      .message-bubble {
        background: #fff;
        padding: 12px 16px;
        border-radius: 18px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        word-wrap: break-word;
        position: relative;
        line-height: 1.4;
      }

      .message.own .message-bubble {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border-radius: 18px 18px 4px 18px;
      }

      .message:not(.own) .message-bubble {
        border-radius: 18px 18px 18px 4px;
      }

      .message-time {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 4px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .message.own .message-time {
        color: rgba(255, 255, 255, 0.8);
      }

      .message:not(.own) .message-time {
        color: #999;
      }

      .message-status-ticks {
        margin-left: 8px;
        display: flex;
        align-items: center;
      }

      .status-tick {
        font-size: 12px;
        margin-left: 2px;
      }

      .status-tick.status-sent {
        color: rgba(255, 255, 255, 0.6);
      }

      .status-tick.status-delivered {
        color: rgba(255, 255, 255, 0.8);
      }

      .status-tick.status-read {
        color: #4caf50;
      }

      .status-tick.status-sending {
        color: rgba(255, 255, 255, 0.4);
        animation: pulse 1s infinite;
      }

      /* Better message alignment */
      .message {
        margin-bottom: 16px;
        display: flex;
        gap: 12px;
        animation: fadeIn 0.3s ease;
        max-width: 100%;
      }

      .message.own {
        flex-direction: row-reverse;
        justify-content: flex-start;
        margin-left: auto;
        margin-right: 0;
      }

      .message:not(.own) {
        justify-content: flex-start;
        margin-left: 0;
        margin-right: auto;
      }

      .message-content {
        max-width: 70%;
        display: flex;
        flex-direction: column;
      }

      .message.own .message-content {
        align-items: flex-end;
      }

      .message:not(.own) .message-content {
        align-items: flex-start;
      }

      .message-info {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 4px;
        font-size: 11px;
        color: #666;
      }

      .message.own .message-info {
        justify-content: flex-end;
      }

      .message-status-enhanced {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 10px;
        color: #666;
      }

      .status-text {
        font-size: 10px;
      }

      .status-icon {
        width: 12px;
        height: 12px;
      }

      .status-sent {
        color: #6c757d;
      }
      .status-delivered {
        color: #28a745;
      }
      .status-read {
        color: #007bff;
      }

      /* Message Input */
      .message-input-container {
        padding: 20px;
        background: #fff;
        border-top: 1px solid #e9ecef;
      }

      .message-input-wrapper {
        display: flex;
        gap: 12px;
        align-items: flex-end;
      }

      .message-input {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #ddd;
        border-radius: 24px;
        resize: none;
        font-family: inherit;
        font-size: 14px;
        max-height: 120px;
        min-height: 44px;
      }

      .message-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .send-button {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .send-button:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .send-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      /* Search Bar */
      .search-container {
        padding: 12px 20px;
        border-bottom: 1px solid #e9ecef;
      }

      .search-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 20px;
        font-size: 14px;
        background: #f8f9fa;
      }

      .search-input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
      }

      /* System Log */
      .system-log {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 350px;
        max-height: 300px;
        background: rgba(0, 0, 0, 0.95);
        color: #00ff00;
        border-radius: 8px;
        padding: 12px;
        font-family: "Courier New", monospace;
        font-size: 11px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        border: 1px solid #333;
      }

      .log-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1001;
        transition: all 0.2s;
      }

      .log-toggle:hover {
        background: rgba(0, 0, 0, 0.9);
        transform: scale(1.1);
      }

      /* Empty State */
      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #666;
        text-align: center;
        padding: 40px;
      }

      .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      /* Loading */
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        color: #666;
      }

      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Notifications */
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        border-radius: 6px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
      }

      .notification.success {
        background: #28a745;
        color: white;
      }

      .notification.error {
        background: #dc3545;
        color: white;
      }

      .notification.info {
        background: #17a2b8;
        color: white;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .container {
          flex-direction: column;
          height: 100vh;
          border-radius: 0;
        }

        .sidebar {
          width: 100%;
          height: 250px;
          border-right: none;
          border-bottom: 1px solid #e9ecef;
        }

        .rooms-section {
          max-height: 120px;
        }

        .message-content {
          max-width: 85%;
        }

        .system-log {
          width: 90%;
          right: 5%;
        }

        .room-avatar img,
        .avatar-placeholder {
          width: 40px;
          height: 40px;
        }

        .room-header h4 {
          font-size: 14px;
        }

        .room-subtitle {
          font-size: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="user-info">
            <div class="user-avatar">A</div>
            <div>
              <div style="font-weight: 600; font-size: 14px">XYZ User</div>
              <div style="font-size: 11px; color: #666">6cb0985e-b1a7-4845-97a3-7c295ab04cef</div>
            </div>
          </div>
          <div class="connection-status">
            <div class="status-dot" id="connectionDot"></div>
            <span id="connectionStatus">Connecting...</span>
          </div>
        </div>

        <div class="search-container">
          <input
            type="text"
            class="search-input"
            id="roomSearch"
            placeholder="Search conversations..."
            oninput="filterRooms()"
          />
        </div>

        <div class="room-creation">
          <div class="form-group">
            <label>Chat Type</label>
            <select class="form-control" id="chatType">
              <option value="DIRECT">Direct Chat</option>
              <option value="LISTING">Listing Chat</option>
            </select>
          </div>

          <div class="form-group">
            <label>Participant IDs</label>
            <input
              type="text"
              class="form-control"
              id="participantIds"
              placeholder="user1,user2"
            />
          </div>

          <div class="form-group" id="listingGroup" style="display: none">
            <label>Listing ID</label>
            <input
              type="text"
              class="form-control"
              id="listingId"
              placeholder="listing-id"
            />
          </div>

          <div style="display: flex; gap: 8px">
            <button
              class="btn btn-primary"
              onclick="joinOrCreateRoom()"
              style="flex: 1"
              id="createRoomBtn"
            >
              <i class="fas fa-plus"></i> Create/Join Room
            </button>
            <button
              class="btn btn-secondary"
              onclick="getUserRooms()"
              title="Refresh Rooms"
            >
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
        </div>

        <div class="rooms-section">
          <div class="section-header">
            <span>Chat Rooms</span>
            <span id="roomCount">0</span>
          </div>
          <div id="roomsList">
            <div class="loading">
              <div class="spinner"></div>
              Loading rooms...
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Area -->
      <div class="chat-area">
        <div class="chat-header" id="chatHeader" style="display: none">
          <div class="chat-title">
            <div>
              <h3 id="chatTitle">Select a room</h3>
              <div class="chat-subtitle" id="chatSubtitle">
                Choose a room to start chatting
              </div>
            </div>
          </div>
          <div class="chat-actions">
            <button
              class="btn btn-secondary"
              onclick="getChatHistory()"
              title="Load History"
            >
              <i class="fas fa-history"></i>
            </button>
            <button
              class="btn btn-secondary"
              onclick="clearMessages()"
              title="Clear Messages"
            >
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>

        <div class="messages-container" id="messagesContainer">
          <div class="empty-state">
            <i class="fas fa-comment-dots"></i>
            <h3>Welcome to Chat</h3>
            <p>Create or join a room to start messaging</p>
          </div>
        </div>

        <div
          class="message-input-container"
          id="messageInputContainer"
          style="display: none"
        >
          <div class="message-input-wrapper">
            <textarea
              class="message-input"
              id="messageInput"
              placeholder="Type your message..."
              rows="1"
            ></textarea>
            <button
              class="send-button"
              id="sendButton"
              onclick="sendMessage()"
              disabled
            >
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- System Log Toggle -->
    <button class="log-toggle" onclick="toggleLog()" title="Toggle System Log">
      <i class="fas fa-terminal"></i>
    </button>
    <div class="system-log" id="systemLog"></div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      // Configuration
      const SOCKET_URL = "http://localhost:8000";
      const AUTH_TOKEN =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjp7ImlkIjoiNmNiMDk4NWUtYjFhNy00ODQ1LTk3YTMtN2MyOTVhYjA0Y2VmIn0sImlhdCI6MTc1MDQ4NzQyMiwiZXhwIjoxNzUzMDc5NDIyfQ.P3f_sKwS0bYgayNxZT6818CnsAEiKHLa48lO0Fqsv7E";

      // Initialize Socket
      const socket = io(SOCKET_URL, {
        auth: { token: AUTH_TOKEN },
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionAttempts: 5,
      });

      // State Management
      let currentRoomId = null;
      let currentUser = "6cb0985e-b1a7-4845-97a3-7c295ab04cef";
      let rooms = new Map();
      let messages = new Map();
      let logVisible = false;
      let isConnected = false;

      // Initialize App
      document.addEventListener("DOMContentLoaded", function () {
        initializeApp();
      });

      function initializeApp() {
        // Chat type change handler
        document
          .getElementById("chatType")
          .addEventListener("change", function () {
            const listingGroup = document.getElementById("listingGroup");
            listingGroup.style.display =
              this.value === "LISTING" ? "block" : "none";
          });

        // Auto-resize textarea
        const messageInput = document.getElementById("messageInput");
        messageInput.addEventListener("input", function () {
          this.style.height = "auto";
          this.style.height = Math.min(this.scrollHeight, 120) + "px";

          // Enable/disable send button
          const sendButton = document.getElementById("sendButton");
          sendButton.disabled =
            !this.value.trim() || !currentRoomId || !isConnected;
        });

        // Enter key to send message
        messageInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

        // Form validation
        ["chatType", "participantIds", "listingId"].forEach((id) => {
          document.getElementById(id).addEventListener("input", validateForm);
        });
      }

      function validateForm() {
        const type = document.getElementById("chatType").value;
        const participants = document
          .getElementById("participantIds")
          .value.trim();
        const listing = document.getElementById("listingId").value.trim();

        const isValid = type && participants && (type !== "LISTING" || listing);
        document.getElementById("createRoomBtn").disabled =
          !isValid || !isConnected;
      }

      // Socket Event Handlers
      socket.on("connect", () => {
        log("‚úÖ Connected to server");
        updateConnectionStatus(true);
        getUserRooms();
        validateForm();
      });

      socket.on("disconnect", (reason) => {
        log(`‚ùå Disconnected from server: ${reason}`);
        updateConnectionStatus(false);
        validateForm();
      });

      socket.on("connect_error", (error) => {
        log(`‚ùó Connection error: ${error.message}`);
        updateConnectionStatus(false);
      });

      socket.on("room_created", (data) => {
        log("üéâ Room Created", data);
        handleRoomJoined(data);
        showNotification("Room created successfully!", "success");
      });

      socket.on("room_joined", (data) => {
        log("üëã Joined Existing Room", data);
        handleRoomJoined(data);
        showNotification("Joined room successfully!", "success");
      });

      socket.on("new_room", (data) => {
        log("üîî New Room Notification", data);
        addRoomToList(data);
        showNotification("You've been added to a new room!", "info");
      });

      socket.on("receive_message", (data) => {
        log("üì® Message Received", data);
        handleMessageReceived(data);

        // Mark as delivered if we're in the room
        if (data.chatId === currentRoomId) {
          markMessageDelivered(data.id);
        }
      });

      socket.on("notify", (data) => {
        log("üîî New Message Notification", data);
        handleMessageReceived(data);

        // Auto-emit message delivered when notify is received
        if (data.id) {
          socket.emit("message-delivered", { messageId: data.id });
        }

        // Show notification only if not in the current room
        if (data.chatId !== currentRoomId) {
          showNotification(
            `New message from ${data.sender?.fullName || "Unknown"}`,
            "info"
          );
        }
      });

      // Add new event handler for message status updates
      socket.on("message-status-updated", (data) => {
        log("üìä Message Status Updated", data);
        updateMessageStatus(data.messageId, data.status);
      });

      socket.on("message_sent", (data) => {
        log("üì§ Message Sent Confirmation", data);
        handleMessageReceived(data);
      });

      socket.on("message_delivered", (data) => {
        log("‚úÖ Message Delivered", data);
        updateMessageStatus(data.id, "DELIVERED");
      });

      socket.on("message_read", (data) => {
        log("üëÅÔ∏è Message Read", data);
        updateMessageStatus(data.id, "READ");
      });

      socket.on("room_list", (data) => {
        log("üìã Room List Received", data);
        handleRoomList(data.roomsList || data); // Handle both old and new structure
      });

      socket.on("chat_history", (data) => {
        log("üìú Chat History Received", data);
        handleChatHistory(data);
      });

      socket.on("error", (err) => {
        log("‚ùó Error: " + err.message);
        showNotification("Error: " + err.message, "error");
      });

      // Connection Management
      function updateConnectionStatus(connected) {
        isConnected = connected;
        const statusDot = document.getElementById("connectionDot");
        const statusText = document.getElementById("connectionStatus");

        if (connected) {
          statusDot.classList.add("connected");
          statusText.textContent = "Connected";
        } else {
          statusDot.classList.remove("connected");
          statusText.textContent = "Disconnected";
        }

        // Update UI state
        const messageInput = document.getElementById("messageInput");
        const sendButton = document.getElementById("sendButton");

        if (!connected) {
          messageInput.disabled = true;
          sendButton.disabled = true;
        } else if (currentRoomId) {
          messageInput.disabled = false;
          sendButton.disabled = !messageInput.value.trim();
        }
      }

      // Room Management Functions
      function joinOrCreateRoom() {
        const type = document.getElementById("chatType").value;
        const participantIds = document
          .getElementById("participantIds")
          .value.split(",")
          .map((s) => s.trim())
          .filter((s) => s);
        const listingId = document.getElementById("listingId").value.trim();

        if (!type || participantIds.length === 0) {
          showNotification(
            "Please provide chat type and participant IDs",
            "error"
          );
          return;
        }

        if (type === "LISTING" && !listingId) {
          showNotification(
            "Please provide listing ID for listing chat",
            "error"
          );
          return;
        }

        const data = { type, participantIds };
        if (listingId) data.listingId = listingId;

        // Show loading state
        const btn = document.getElementById("createRoomBtn");
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
        btn.disabled = true;

        socket.emit("joinOrCreateRoom", data);

        // Reset button after timeout
        setTimeout(() => {
          btn.innerHTML = originalText;
          validateForm();
        }, 3000);
      }

      function getUserRooms() {
        socket.emit("get_user_rooms");
      }

      function handleRoomJoined(roomData) {
        currentRoomId = roomData.id;
        addRoomToList(roomData);
        selectRoom(roomData.id);
        enableChat();

        // Clear form
        document.getElementById("participantIds").value = "";
        document.getElementById("listingId").value = "";
      }

      function handleRoomList(roomsData) {
        rooms.clear();
        const roomsList = document.getElementById("roomsList");

        if (!roomsData || roomsData.length === 0) {
          roomsList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-comments"></i>
                <p>No rooms yet</p>
                <small>Create a room to start chatting</small>
            </div>
        `;
          document.getElementById("roomCount").textContent = "0";
          return;
        }

        roomsList.innerHTML = "";

        // Sort rooms by last activity
        const sortedRooms = roomsData.sort((a, b) => {
          const aTime = a.lastActivityAt || a.updatedAt;
          const bTime = b.lastActivityAt || b.updatedAt;
          return new Date(bTime) - new Date(aTime);
        });

        sortedRooms.forEach((room) => {
          addRoomToList(room);
        });

        document.getElementById("roomCount").textContent = roomsData.length;
      }

      function addRoomToList(roomData) {
        const roomId = roomData.roomId;
        const roomType = roomData.type?.toUpperCase() || "DIRECT";

        // Convert new structure for compatibility
        const convertedRoom = {
          id: roomId,
          type: roomType,
          participants:
            roomData.participant?.map((p) => ({
              userId: p.id,
              user: { fullName: p.name },
            })) || [],
          createdAt: roomData.createdAt,
          updatedAt: roomData.lastActivityAt,
          lastMessage: {
            content:
              roomData.subtitle !== "No messages yet"
                ? roomData.subtitle
                : null,
            timestamp: roomData.lastActivityAt,
          },
        };

        rooms.set(roomId, convertedRoom);
        const roomsList = document.getElementById("roomsList");

        // Remove empty state if exists
        const emptyState = roomsList.querySelector(".empty-state");
        if (emptyState) emptyState.remove();

        // Check if room already exists
        let roomElement = document.getElementById(`room-${roomId}`);
        if (!roomElement) {
          roomElement = document.createElement("div");
          roomElement.className = "room-item";
          roomElement.id = `room-${roomId}`;
          roomElement.onclick = () => selectRoom(roomId);
          roomsList.insertBefore(roomElement, roomsList.firstChild);
        }

        // Add online status indicator based on hasActivity
        const onlineIndicator = roomData.hasActivity
          ? '<div class="online-indicator"></div>'
          : "";

        roomElement.innerHTML = `
        <div class="room-info">
            <div class="room-avatar">
                ${
                  roomData.avatar
                    ? `<img src="${roomData.avatar}" alt="${roomData.title}">`
                    : `<div class="avatar-placeholder">${roomData.title
                        .charAt(0)
                        .toUpperCase()}</div>`
                }
                ${onlineIndicator}
            </div>
            <div class="room-details">
                <div class="room-header">
                    <h4>${roomData.title}</h4>
                    <div class="room-meta">
                        <span class="timestamp">${roomData.timestamp}</span>
                        ${
                          roomData.unreadCount > 0
                            ? `<div class="unread-badge">${roomData.unreadCount}</div>`
                            : ""
                        }
                    </div>
                </div>
                <div class="room-subtitle">
                    <span class="${
                      roomData.subtitle.startsWith("You:") ? "own-message" : ""
                    }">${roomData.subtitle}</span>
                    ${
                      roomData.hasUnreadMessages
                        ? '<i class="fas fa-circle unread-dot"></i>'
                        : ""
                    }
                </div>
                <div class="room-type">${roomType.toLowerCase()} ‚Ä¢ ${
          roomData.participant?.length || 0
        } members</div>
            </div>
        </div>
    `;

        document.getElementById("roomCount").textContent = rooms.size;
      }

      function selectRoom(roomId) {
        // Update UI
        document.querySelectorAll(".room-item").forEach((item) => {
          item.classList.remove("active");
        });

        const roomElement = document.getElementById(`room-${roomId}`);
        if (roomElement) {
          roomElement.classList.add("active");

          // Clear unread indicators
          const unreadBadge = roomElement.querySelector(".unread-badge");
          if (unreadBadge) {
            unreadBadge.style.display = "none";
          }

          const unreadDot = roomElement.querySelector(".unread-dot");
          if (unreadDot) {
            unreadDot.style.display = "none";
          }
        }

        currentRoomId = roomId;
        const room = rooms.get(roomId);

        // Update chat header
        const chatHeader = document.getElementById("chatHeader");
        const chatTitle = document.getElementById("chatTitle");
        const chatSubtitle = document.getElementById("chatSubtitle");

        if (room) {
          const otherParticipants =
            room.participants?.filter((p) => p.userId !== currentUser) || [];
          const participantNames = otherParticipants
            .map((p) => p.user?.fullName || p.userId?.slice(0, 8) || "Unknown")
            .join(", ");

          chatTitle.textContent = `${room.type} Chat`;
          chatSubtitle.textContent =
            participantNames || "No other participants";
          chatHeader.style.display = "flex";
        }

        // Load messages for this room
        displayRoomMessages(roomId);
        enableChat();

        // Mark messages as read
        markRoomMessagesAsRead(roomId);

        // Get chat history
        getChatHistory();

        // Show loading state
        showLoadingMessages();
      }

      function showLoadingMessages() {
        const container = document.getElementById("messagesContainer");
        container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Loading messages...
                </div>
            `;
      }

      // Message Functions
      function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const content = messageInput.value.trim();

        if (!content) {
          showNotification("Please enter a message", "error");
          return;
        }

        if (!currentRoomId) {
          showNotification("Please select a room first", "error");
          return;
        }

        if (!isConnected) {
          showNotification("Not connected to server", "error");
          return;
        }

        const messageData = {
          roomId: currentRoomId, // Fixed: use roomId instead of chatId
          content: content,
          timestamp: new Date().toISOString(),
        };

        // Show sending state
        const sendButton = document.getElementById("sendButton");
        sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        sendButton.disabled = true;

        socket.emit("send_message", messageData);

        // Clear input and reset button
        messageInput.value = "";
        messageInput.style.height = "auto";

        setTimeout(() => {
          sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
          sendButton.disabled = false;
        }, 1000);
      }

      function handleMessageReceived(messageData) {
        // Store message
        if (!messages.has(messageData.chatId)) {
          messages.set(messageData.chatId, []);
        }

        const roomMessages = messages.get(messageData.chatId);
        const existingIndex = roomMessages.findIndex(
          (m) => m.id === messageData.id
        );

        if (existingIndex >= 0) {
          roomMessages[existingIndex] = messageData;
        } else {
          roomMessages.push(messageData);
          roomMessages.sort(
            (a, b) =>
              new Date(a.createdAt || a.timestamp) -
              new Date(b.createdAt || b.timestamp)
          );
        }

        // Update UI if this is the current room
        if (messageData.chatId === currentRoomId) {
          displayRoomMessages(currentRoomId);
        }

        // Update room list with latest message preview
        updateRoomLastMessage(messageData.chatId, messageData);
      }

      function displayRoomMessages(roomId) {
        const container = document.getElementById("messagesContainer");
        const roomMessages = messages.get(roomId) || [];

        if (roomMessages.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comment-dots"></i>
                        <h3>No messages yet</h3>
                        <p>Start the conversation!</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = "";
        roomMessages.forEach((message) => {
          displayMessage(message);
        });

        // Scroll to bottom
        setTimeout(() => {
          container.scrollTop = container.scrollHeight;
        }, 100);
      }

      function displayMessage(messageData) {
        const container = document.getElementById("messagesContainer");
        const isOwnMessage = messageData.sender.id === currentUser;

        // Remove existing message if updating
        const existingMessage = document.getElementById(
          `message-${messageData.id}`
        );
        if (existingMessage) {
          existingMessage.remove();
        }

        const messageElement = document.createElement("div");
        messageElement.className = `message ${isOwnMessage ? "own" : ""}`;
        messageElement.id = `message-${messageData.id}`;

        const senderName = isOwnMessage
          ? "You"
          : messageData.sender?.fullName || "Unknown";
        const senderInitial = senderName.charAt(0).toUpperCase();

        messageElement.innerHTML = `
        <div class="message-avatar">${senderInitial}</div>
        <div class="message-content">
            <div class="message-bubble">
                ${escapeHtml(messageData.content)}
                <div class="message-time">
                    ${formatTime(
                      messageData.createdAt || messageData.timestamp
                    )}
                    ${
                      isOwnMessage
                        ? `
                        <span class="message-status-ticks">
                            ${getStatusTicks(messageData.status || "SENT")}
                        </span>
                    `
                        : ""
                    }
                </div>
            </div>
            <div class="message-info">
                <span>${senderName}</span>
            </div>
        </div>
    `;

        container.appendChild(messageElement);
      }

      function getStatusTicks(status) {
        switch (status) {
          case "SENT":
            return '<i class="fas fa-check status-tick status-sent" title="Sent"></i>';
          case "DELIVERED":
            return '<i class="fas fa-check-double status-tick status-delivered" title="Delivered"></i>';
          case "READ":
            return '<i class="fas fa-check-double status-tick status-read" title="Read"></i>';
          default:
            return '<i class="fas fa-clock status-tick status-sending" title="Sending"></i>';
        }
      }

      function getStatusText(status) {
        switch (status) {
          case "SENT":
            return "Sent";
          case "DELIVERED":
            return "Delivered";
          case "READ":
            return "Read";
          default:
            return "Sending";
        }
      }

      function getStatusIcon(status) {
        switch (status) {
          case "SENT":
            return '<i class="fas fa-check status-icon status-sent" title="Sent"></i>';
          case "DELIVERED":
            return '<i class="fas fa-check-double status-icon status-delivered" title="Delivered"></i>';
          case "READ":
            return '<i class="fas fa-check-double status-icon status-read" title="Read"></i>';
          default:
            return '<i class="fas fa-clock status-icon status-sent" title="Sending"></i>';
        }
      }

      function updateMessageStatus(messageId, status) {
        const messageElement = document.getElementById(`message-${messageId}`);
        if (messageElement) {
          const statusElement = messageElement.querySelector(
            ".message-status-ticks"
          );
          if (statusElement) {
            statusElement.innerHTML = getStatusTicks(status);
          }
        }

        // Update in memory
        for (let [roomId, roomMessages] of messages) {
          const messageIndex = roomMessages.findIndex(
            (m) => m.id === messageId
          );
          if (messageIndex >= 0) {
            roomMessages[messageIndex].status = status;
            break;
          }
        }
      }

      function markMessageDelivered(messageId) {
        socket.emit("message-delivered", { messageId });
      }

      function markMessageRead(messageId) {
        socket.emit("message-read", { messageId });
      }

      function markRoomMessagesAsRead(roomId) {
        const roomMessages = messages.get(roomId) || [];
        let IdArray = [];
        roomMessages.forEach((message) => {
          if (message.sender.id !== currentUser && message.status !== "READ") {
            // console.log(message, "testtttt");

            IdArray.push(message.id);
          }
        });
        markMessageRead(IdArray);
      }

      function getChatHistory() {
        if (!currentRoomId) return;

        socket.emit("getChatHistory", {
          roomId: currentRoomId,
          page: 1,
          pageSize: 50,
        });
      }

      function handleChatHistory(data) {
        if (data.roomId !== currentRoomId) return;

        // Handle nested messages structure
        const messagesData = data.messages?.messages.reverse() || data.messages.reverse() || [];
        // Store messages
        messages.set(data.roomId, messagesData);

        // Display messages
        displayRoomMessages(data.roomId);

        // Mark messages as read when loaded
        markRoomMessagesAsRead(data.roomId);

        log(`Loaded ${messagesData.length} messages for room ${data.roomId}`);
      }

      function clearMessages() {
        if (!currentRoomId) return;

        if (
          confirm("Are you sure you want to clear messages from this view?")
        ) {
          const container = document.getElementById("messagesContainer");
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comment-dots"></i>
                        <h3>Messages cleared</h3>
                        <p>Send a message to start the conversation</p>
                    </div>
                `;
        }
      }

      function updateRoomLastMessage(roomId, messageData) {
        const room = rooms.get(roomId);
        if (!room) return;

        room.lastMessage = {
          content: messageData.content,
          sender: messageData.sender,
          senderId: messageData.senderId,
          timestamp: messageData.createdAt || messageData.timestamp,
        };

        const roomElement = document.getElementById(`room-${roomId}`);
        if (roomElement) {
          const subtitleElement = roomElement.querySelector(
            ".room-subtitle span"
          );
          const timestampElement = roomElement.querySelector(".timestamp");

          if (subtitleElement && timestampElement) {
            subtitleElement.textContent = `${
              messageData.sender?.fullName || "Unknown"
            }: ${messageData.content}`;
            subtitleElement.className =
              messageData.senderId === currentUser ? "own-message" : "";
            timestampElement.textContent = formatTime(
              messageData.createdAt || messageData.timestamp
            );
          }

          // Move room to top
          const roomsList = document.getElementById("roomsList");
          roomsList.insertBefore(roomElement, roomsList.firstChild);
        }
      }

      // UI Helper Functions
      function enableChat() {
        const messageInput = document.getElementById("messageInput");
        const sendButton = document.getElementById("sendButton");
        const inputContainer = document.getElementById("messageInputContainer"); // Fixed typo

        if (isConnected && currentRoomId) {
          messageInput.disabled = false;
          sendButton.disabled = !messageInput.value.trim();
          inputContainer.style.display = "block";
          messageInput.focus();
        }
      }

      function formatTime(timestamp) {
        if (!timestamp) return "";

        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;

        // Less than 1 minute
        if (diff < 60000) {
          return "now";
        }

        // Less than 1 hour
        if (diff < 3600000) {
          return `${Math.floor(diff / 60000)}m`;
        }

        // Less than 24 hours
        if (diff < 86400000) {
          return `${Math.floor(diff / 3600000)}h`;
        }

        // Less than 7 days
        if (diff < 604800000) {
          return `${Math.floor(diff / 86400000)}d`;
        }

        // Show date
        return date.toLocaleDateString();
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.innerHTML = `
                <i class="fas fa-${
                  type === "success"
                    ? "check-circle"
                    : type === "error"
                    ? "exclamation-circle"
                    : "info-circle"
                }"></i>
                ${message}
            `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 4000);
      }

      // System Log Functions
      function toggleLog() {
        const log = document.getElementById("systemLog");
        logVisible = !logVisible;
        log.style.display = logVisible ? "block" : "none";
      }

      function log(message, data = null) {
        const logElement = document.getElementById("systemLog");
        const timestamp = new Date().toLocaleTimeString();

        let logMessage = `[${timestamp}] ${message}`;
        if (data) {
          logMessage += "\n" + JSON.stringify(data, null, 2);
        }

        logElement.textContent += logMessage + "\n\n";
        logElement.scrollTop = logElement.scrollHeight;

        // Keep log size manageable
        const lines = logElement.textContent.split("\n");
        if (lines.length > 200) {
          logElement.textContent = lines.slice(-150).join("\n");
        }
      }

      // Search functionality
      function filterRooms() {
        const searchTerm = document
          .getElementById("roomSearch")
          .value.toLowerCase();
        const roomItems = document.querySelectorAll(".room-item");

        roomItems.forEach((item) => {
          const title = item.querySelector("h4").textContent.toLowerCase();
          const subtitle = item
            .querySelector(".room-subtitle span")
            .textContent.toLowerCase();

          if (title.includes(searchTerm) || subtitle.includes(searchTerm)) {
            item.style.display = "block";
          } else {
            item.style.display = "none";
          }
        });
      }

      // Initialize on page load
      window.addEventListener("load", () => {
        log("Application initialized");
      });

      // Handle page visibility for read receipts
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden && currentRoomId) {
          markRoomMessagesAsRead(currentRoomId);
        }
      });

      // Auto-refresh rooms every 30 seconds
      setInterval(() => {
        if (isConnected) {
          getUserRooms();
        }
      }, 30000);
    </script>
  </body>
</html>
